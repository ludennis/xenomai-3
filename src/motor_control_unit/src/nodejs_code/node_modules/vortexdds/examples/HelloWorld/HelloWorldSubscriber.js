/*
 *                         Vortex OpenSplice
 *
 *   This software and documentation are Copyright 2006 to 2019 ADLINK
 *   Technology Limited, its affiliated companies and licensors. All rights
 *   reserved.
 *
 *   Licensed under the Apache License, Version 2.0 (the "License");
 *   you may not use this file except in compliance with the License.
 *   You may obtain a copy of the License at
 *
 *       http://www.apache.org/licenses/LICENSE-2.0
 *
 *   Unless required by applicable law or agreed to in writing, software
 *   distributed under the License is distributed on an "AS IS" BASIS,
 *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *   See the License for the specific language governing permissions and
 *   limitations under the License.
 *
 */

/*
    Hello World example.
    Instructions: 1. Run nodejs HelloWorldSubscriber.js
                  2. Run nodejs HelloWorldPublisher.js
*/

'use strict';

const dds = require('vortexdds');
const path = require('path');

main();

function main(){
  subscribeData().then(() => {
    console.log('=== HelloWorldSubscriber end');
    process.exit(0);
  }).catch((error) => {
    console.log('Error: ' + error.message);
    process.exit(1);
  });
}

async function subscribeData(){

  console.log('=== HelloWorldSubscriber start');

  let participant = null;
  try {
    participant = new dds.Participant();

    const topicName = 'HelloWorldData_Msg';
    const idlName = 'HelloWorldData.idl';
    const idlPath = __dirname + path.sep + idlName;
    const typeSupports = await dds.importIDL(idlPath);
    const typeSupport = typeSupports.get('HelloWorldData::Msg');

    const tqos = dds.QoS.topicDefault();

    tqos.durability = {kind: dds.DurabilityKind.Transient};
    tqos.reliability = {kind: dds.ReliabilityKind.Reliable};

    const topic = participant.createTopic(
      topicName,
      typeSupport,
      tqos
    );

    const sqos = dds.QoS.subscriberDefault();

    sqos.partition = {names: 'HelloWorld example'};
    const sub = participant.createSubscriber(sqos);

    const rqos = dds.QoS.readerDefault();

    rqos.durability = {kind: dds.DurabilityKind.Transient};
    rqos.reliability = {kind: dds.ReliabilityKind.Reliable};
    const reader = sub.createReader(topic, rqos);

    console.log('=== [Subscriber] Ready ...');
    await takeData(reader);

  } finally {
    console.log('=== Cleanup resources');
    if (participant !== null){
      participant.delete().catch((error) => {
        console.log('Error cleaning up resources: '
          + error.message);
      });
    }
  }
}

function takeData(reader) {
  let numAttemps = 0;
  return new Promise(resolve => {
    let interval = setInterval(() => {
      numAttemps++;
      if (numAttemps >= 100) {
        clearInterval(interval);
        resolve(null);
      }

      let takeArray = reader.take(1);
      if (takeArray.length > 0 && takeArray[0].info.valid_data) {
        console.log('=== [Subscriber] message received :');
        console.log('    userID  : ' + takeArray[0].sample.userID);
        console.log('    Message : ' + takeArray[0].sample.message);
        clearInterval(interval);
        resolve(null);
      }

    }, 200);
  });
}
